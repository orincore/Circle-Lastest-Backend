# ============================================
# Circle Backend - Production Docker Compose
# Blue-Green Deployment with Load Balancing
# Optimized for 8GB RAM / 2 vCPU instance
# ============================================
# 
# Architecture:
# - Two sets of containers (Blue & Green) for zero-downtime deployments
# - Load balancing distributes traffic across both sets during normal operation
# - Rolling updates: update one set while other handles traffic
# - Resource allocation optimized for dual-set operation
#
# Memory Budget (8GB total):
# - Redis: 256MB
# - NGINX: 100MB
# - API Blue: 768MB | API Green: 768MB
# - Socket Blue: 768MB | Socket Green: 768MB
# - Matchmaking Blue: 256MB | Matchmaking Green: 256MB
# - Cron: 256MB
# - OS/Buffer: ~2.8GB
# ============================================

# Shared configuration
x-common-env: &common-env
  NODE_ENV: production
  REDIS_HOST: redis
  REDIS_PORT: 6379
  TZ: Asia/Kolkata

x-healthcheck-defaults: &healthcheck-defaults
  interval: 15s
  timeout: 10s
  retries: 5
  start_period: 60s

x-logging: &logging
  driver: json-file
  options:
    max-size: "10m"
    max-file: "3"

x-deploy-defaults: &deploy-defaults
  restart_policy:
    condition: on-failure
    delay: 3s
    max_attempts: 5
    window: 60s

# ============================================
# Shared API configuration for Blue/Green
# ============================================
x-api-base: &api-base
  build:
    context: .
    dockerfile: docker/Dockerfile.api
    args:
      CACHEBUST: ${CACHEBUST:-1}
  image: circle-backend/api:${TAG:-latest}
  env_file:
    - .env.production
  networks:
    - circle-network
  deploy:
    <<: *deploy-defaults
    resources:
      limits:
        memory: 768M
        cpus: '0.5'
      reservations:
        memory: 384M
        cpus: '0.25'
  logging: *logging
  healthcheck:
    test: ["CMD", "node", "-e", "require('http').get('http://localhost:8080/health', (r) => process.exit(r.statusCode === 200 ? 0 : 1)).on('error', () => process.exit(1))"]
    <<: *healthcheck-defaults
  restart: unless-stopped

# ============================================
# Shared Socket configuration for Blue/Green
# ============================================
x-socket-base: &socket-base
  build:
    context: .
    dockerfile: docker/Dockerfile.socket
    args:
      CACHEBUST: ${CACHEBUST:-1}
  image: circle-backend/socket:${TAG:-latest}
  env_file:
    - .env.production
  networks:
    - circle-network
  deploy:
    <<: *deploy-defaults
    resources:
      limits:
        memory: 768M
        cpus: '0.5'
      reservations:
        memory: 384M
        cpus: '0.25'
  logging: *logging
  healthcheck:
    test: ["CMD", "node", "-e", "require('http').get('http://localhost:8081/health', (r) => process.exit(r.statusCode === 200 ? 0 : 1)).on('error', () => process.exit(1))"]
    <<: *healthcheck-defaults
  restart: unless-stopped

# ============================================
# Shared Matchmaking configuration for Blue/Green
# ============================================
x-matchmaking-base: &matchmaking-base
  build:
    context: .
    dockerfile: docker/Dockerfile.matchmaking
    args:
      CACHEBUST: ${CACHEBUST:-1}
  image: circle-backend/matchmaking:${TAG:-latest}
  env_file:
    - .env.production
  networks:
    - circle-network
  deploy:
    <<: *deploy-defaults
    resources:
      limits:
        memory: 256M
        cpus: '0.15'
      reservations:
        memory: 128M
  logging: *logging
  restart: unless-stopped

services:
  # ============================================
  # NGINX Reverse Proxy & Load Balancer
  # RAM: ~50-100MB | CPU: Low
  # Routes traffic to both Blue and Green sets
  # ============================================
  nginx:
    image: nginx:alpine
    container_name: circle-nginx
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./docker/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./docker/ssl:/etc/nginx/ssl:ro
      - /etc/letsencrypt:/etc/letsencrypt:ro
      - nginx_logs:/var/log/nginx
    depends_on:
      redis:
        condition: service_healthy
    networks:
      - circle-network
    extra_hosts:
      - "host.docker.internal:host-gateway"
    deploy:
      <<: *deploy-defaults
      resources:
        limits:
          memory: 100M
          cpus: '0.25'
        reservations:
          memory: 50M
    logging: *logging
    healthcheck:
      test: ["CMD", "nginx", "-t"]
      <<: *healthcheck-defaults
    restart: unless-stopped

  # ============================================
  # Redis Cache & Pub/Sub
  # RAM: ~200-300MB | CPU: Low
  # Shared by both Blue and Green sets
  # ============================================
  redis:
    image: redis:7-alpine
    container_name: circle-redis
    command: >
      redis-server
      --appendonly yes
      --maxmemory 512mb
      --maxmemory-policy allkeys-lru
      --tcp-keepalive 60
      --timeout 0
      --tcp-backlog 1024
      --save 900 1
      --save 300 10
      --save 60 10000
      --activerehashing yes
      --hz 100
      --dynamic-hz yes
      --lazyfree-lazy-eviction yes
      --lazyfree-lazy-expire yes
      --io-threads 2
      --io-threads-do-reads yes
    volumes:
      - redis_data:/data
    networks:
      - circle-network
    deploy:
      <<: *deploy-defaults
      resources:
        limits:
          memory: 300M
          cpus: '0.25'
        reservations:
          memory: 200M
    logging: *logging
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 2s
      retries: 3
      start_period: 10s
    restart: unless-stopped

  # ============================================
  # API Server - BLUE SET
  # ============================================
  api-blue:
    <<: *api-base
    container_name: circle-api-blue
    environment:
      <<: *common-env
      PORT: 8080
      SERVICE_TYPE: api
      DEPLOYMENT_COLOR: blue
      UV_THREADPOOL_SIZE: 8
    expose:
      - "8080"
    volumes:
      - ota_updates:/app/public/updates
    depends_on:
      redis:
        condition: service_healthy
    ulimits:
      nofile:
        soft: 65535
        hard: 65535

  # ============================================
  # API Server - GREEN SET
  # ============================================
  api-green:
    <<: *api-base
    container_name: circle-api-green
    environment:
      <<: *common-env
      PORT: 8080
      SERVICE_TYPE: api
      DEPLOYMENT_COLOR: green
      UV_THREADPOOL_SIZE: 8
    expose:
      - "8080"
    volumes:
      - ota_updates:/app/public/updates
    depends_on:
      redis:
        condition: service_healthy
    ulimits:
      nofile:
        soft: 65535
        hard: 65535

  # ============================================
  # Socket.IO Server - BLUE SET
  # ============================================
  socket-blue:
    <<: *socket-base
    container_name: circle-socket-blue
    environment:
      <<: *common-env
      PORT: 8081
      SERVICE_TYPE: socket
      SOCKET_REDIS_ENABLED: "true"
      DEPLOYMENT_COLOR: blue
      UV_THREADPOOL_SIZE: 8
    expose:
      - "8081"
    depends_on:
      redis:
        condition: service_healthy
    ulimits:
      nofile:
        soft: 65535
        hard: 65535

  # ============================================
  # Socket.IO Server - GREEN SET
  # ============================================
  socket-green:
    <<: *socket-base
    container_name: circle-socket-green
    environment:
      <<: *common-env
      PORT: 8081
      SERVICE_TYPE: socket
      SOCKET_REDIS_ENABLED: "true"
      DEPLOYMENT_COLOR: green
      UV_THREADPOOL_SIZE: 8
    expose:
      - "8081"
    depends_on:
      redis:
        condition: service_healthy
    ulimits:
      nofile:
        soft: 65535
        hard: 65535

  # ============================================
  # Matchmaking Worker - BLUE SET
  # ============================================
  matchmaking-blue:
    <<: *matchmaking-base
    container_name: circle-matchmaking-blue
    environment:
      <<: *common-env
      SERVICE_TYPE: matchmaking-worker
      DEPLOYMENT_COLOR: blue
      MATCHMAKING_INSTANCE_ID: blue
    depends_on:
      redis:
        condition: service_healthy

  # ============================================
  # Matchmaking Worker - GREEN SET
  # ============================================
  matchmaking-green:
    <<: *matchmaking-base
    container_name: circle-matchmaking-green
    environment:
      <<: *common-env
      SERVICE_TYPE: matchmaking-worker
      DEPLOYMENT_COLOR: green
      MATCHMAKING_INSTANCE_ID: green
    depends_on:
      redis:
        condition: service_healthy

  # ============================================
  # Cron Worker (Single Instance - No Blue/Green)
  # Only one cron worker needed to avoid duplicate jobs
  # RAM: ~200-300MB | CPU: Low
  # ============================================
  cron:
    build:
      context: .
      dockerfile: docker/Dockerfile.cron
      args:
        CACHEBUST: ${CACHEBUST:-1}
    image: circle-backend/cron:${TAG:-latest}
    container_name: circle-cron
    environment:
      <<: *common-env
      SERVICE_TYPE: cron-worker
    env_file:
      - .env.production
    volumes:
      - cron_logs:/var/log/cron
    depends_on:
      redis:
        condition: service_healthy
    networks:
      - circle-network
    deploy:
      <<: *deploy-defaults
      resources:
        limits:
          memory: 256M
          cpus: '0.15'
        reservations:
          memory: 100M
    logging: *logging
    restart: unless-stopped

  # ============================================
  # Redis Commander (Optional - Dev/Debug)
  # Disable in production by setting profile
  # ============================================
  redis-commander:
    image: rediscommander/redis-commander:latest
    container_name: circle-redis-ui
    environment:
      - REDIS_HOSTS=local:redis:6379
    ports:
      - "8082:8081"
    depends_on:
      - redis
    networks:
      - circle-network
    profiles:
      - debug
    restart: unless-stopped

# ============================================
# Networks
# ============================================
networks:
  circle-network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.28.0.0/16

# ============================================
# Volumes
# ============================================
volumes:
  redis_data:
    driver: local
  nginx_logs:
    driver: local
  cron_logs:
    driver: local
  ota_updates:
    driver: local
